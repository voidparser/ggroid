<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GGRoid - Star Wars Droid Messenger</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #111;
            color: #eee;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        h1 {
            color: #FFD700;
            font-size: 2em;
        }
        
        .container {
            background-color: #222;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.2);
        }
        
        .controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        textarea {
            width: 100%;
            height: 100px;
            background-color: #333;
            color: #eee;
            border: 1px solid #555;
            border-radius: 5px;
            padding: 10px;
            font-size: 1em;
            resize: vertical;
        }
        
        .sliders {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .slider {
            flex: 1;
            min-width: 200px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
        }
        
        input[type="range"] {
            width: 100%;
            background-color: #333;
            height: 10px;
            border-radius: 5px;
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #FFD700;
            cursor: pointer;
        }
        
        .value-display {
            text-align: right;
            font-size: 0.9em;
            color: #FFD700;
        }
        
        .buttons {
            display: flex;
            gap: 10px;
        }
        
        button {
            flex: 1;
            background-color: #444;
            color: #FFD700;
            border: none;
            border-radius: 5px;
            padding: 12px;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #555;
        }
        
        button:active {
            background-color: #666;
        }
        
        #sendButton {
            background-color: #2a6496;
            color: white;
        }
        
        #sendButton:hover {
            background-color: #357ab7;
        }
        
        .visualization {
            height: 150px;
            background-color: #333;
            border-radius: 5px;
            margin-top: 20px;
            position: relative;
            overflow: hidden;
        }
        
        #r2d2 {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 100px;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateX(-50%) translateY(0px); }
            50% { transform: translateX(-50%) translateY(-10px); }
        }
        
        .received {
            margin-top: 20px;
        }
        
        #receivedMessage {
            background-color: #333;
            border-radius: 5px;
            padding: 10px;
            min-height: 50px;
        }
        
        footer {
            margin-top: 30px;
            text-align: center;
            font-size: 0.8em;
            color: #777;
        }
    </style>
</head>
<body>
    <header>
        <h1>GGRoid - Star Wars Droid Messenger</h1>
        <p>Send messages with R2-D2 sound aesthetics</p>
    </header>
    
    <div class="container">
        <div class="controls">
            <textarea id="messageInput" placeholder="Enter your message here...">Hello, I am R2-D2. This is a secret message.</textarea>
            
            <div class="sliders">
                <div class="slider">
                    <label for="volumeSlider">Volume</label>
                    <input type="range" id="volumeSlider" min="0" max="1" step="0.1" value="0.5">
                    <div class="value-display" id="volumeValue">0.5</div>
                </div>
                
                <div class="slider">
                    <label for="dutySlider">Duty Cycle</label>
                    <input type="range" id="dutySlider" min="0.3" max="0.7" step="0.05" value="0.4">
                    <div class="value-display" id="dutyValue">0.4</div>
                </div>
                
                <div class="slider">
                    <label for="lfoSlider">Warble Rate</label>
                    <input type="range" id="lfoSlider" min="5" max="20" step="1" value="12">
                    <div class="value-display" id="lfoValue">12 Hz</div>
                </div>
            </div>
            
            <div class="buttons">
                <button id="testButton">Test Sound</button>
                <button id="sendButton">Send Message</button>
                <button id="saveButton">Save as WAV</button>
            </div>
        </div>
        
        <div class="visualization">
            <canvas id="audioCanvas" width="800" height="150"></canvas>
            <svg id="r2d2" viewBox="0 0 100 120" xmlns="http://www.w3.org/2000/svg">
                <!-- R2-D2 simple SVG -->
                <circle cx="50" cy="40" r="30" fill="#e0e0e0" stroke="#333" stroke-width="2"/>
                <rect x="30" y="70" width="40" height="50" fill="#e0e0e0" stroke="#333" stroke-width="2" rx="5"/>
                <circle cx="50" cy="30" r="10" fill="#333"/>
                <rect x="45" y="45" width="10" height="5" fill="#333"/>
                <rect x="35" y="55" width="30" height="5" fill="#333"/>
                <rect x="40" y="80" width="5" height="10" fill="#3498db"/>
                <rect x="55" y="80" width="5" height="10" fill="#e74c3c"/>
            </svg>
        </div>
        
        <div class="received">
            <h3>Received Message:</h3>
            <div id="receivedMessage">No messages received yet.</div>
        </div>
    </div>
    
    <footer>
        <p>GGRoid - Enhancing GGWave with Star Wars Droid Aesthetics</p>
    </footer>
    
    <script src="ggwave.js"></script>
    <script>
        // Audio context
        let audioContext;
        let ggwaveInstance;
        let analyser;
        let canvasContext;
        
        // UI elements
        const messageInput = document.getElementById('messageInput');
        const volumeSlider = document.getElementById('volumeSlider');
        const dutySlider = document.getElementById('dutySlider');
        const lfoSlider = document.getElementById('lfoSlider');
        const volumeValue = document.getElementById('volumeValue');
        const dutyValue = document.getElementById('dutyValue');
        const lfoValue = document.getElementById('lfoValue');
        const testButton = document.getElementById('testButton');
        const sendButton = document.getElementById('sendButton');
        const saveButton = document.getElementById('saveButton');
        const receivedMessage = document.getElementById('receivedMessage');
        const audioCanvas = document.getElementById('audioCanvas');
        
        // Initialize canvas
        canvasContext = audioCanvas.getContext('2d');
        
        // Update value displays
        function updateValueDisplays() {
            volumeValue.textContent = volumeSlider.value;
            dutyValue.textContent = dutySlider.value;
            lfoValue.textContent = `${lfoSlider.value} Hz`;
        }
        
        // Add event listeners for sliders
        volumeSlider.addEventListener('input', updateValueDisplays);
        dutySlider.addEventListener('input', updateValueDisplays);
        lfoSlider.addEventListener('input', updateValueDisplays);
        
        // Initial update
        updateValueDisplays();
        
        // Initialize audio context and GGWave
        async function initAudio() {
            if (audioContext) return;
            
            try {
                // Create audio context
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Create analyser for visualization
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;
                analyser.connect(audioContext.destination);
                
                // Initialize GGWave
                ggwaveInstance = await ggwave_factory();
                
                // Set up parameters
                const params = ggwaveInstance.getDefaultParameters();
                params.sampleRateInp = audioContext.sampleRate;
                params.sampleRateOut = audioContext.sampleRate;
                
                // Initialize instance
                ggwaveInstance = ggwaveInstance.init(params);
                
                console.log('Audio and GGWave initialized');
                
                // Start visualization
                visualize();
            } catch (err) {
                console.error('Failed to initialize audio:', err);
                alert('Failed to initialize audio. Please check console for details.');
            }
        }
        
        // Apply R2-D2 effects to audio buffer
        function applyDroidEffects(buffer, settings) {
            // Create a new buffer for the processed audio
            const processedBuffer = new Float32Array(buffer.length);
            
            // Apply the effects
            for (let i = 0; i < buffer.length; i++) {
                // Time in seconds
                const t = i / audioContext.sampleRate;
                
                // LFO modulation (warbling effect)
                const lfoValue = 0.8 + 0.2 * (0.5 + 0.5 * Math.sin(2 * Math.PI * settings.lfoRate * t));
                
                // Apply warbling effect
                processedBuffer[i] = buffer[i] * lfoValue;
            }
            
            // Normalize and apply volume
            const maxAmp = Math.max(...processedBuffer.map(Math.abs));
            for (let i = 0; i < processedBuffer.length; i++) {
                processedBuffer[i] = (processedBuffer[i] / maxAmp) * settings.volume;
            }
            
            return processedBuffer;
        }
        
        // Encode and play a message
        async function sendMessage(message, isTest = false) {
            try {
                // Initialize audio if needed
                await initAudio();
                
                // Resume audio context if suspended
                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                }
                
                // Get settings from sliders
                const settings = {
                    volume: parseFloat(volumeSlider.value),
                    dutyCycle: parseFloat(dutySlider.value),
                    lfoRate: parseFloat(lfoSlider.value)
                };
                
                // Encode message using GGWave
                const protocol = ggwaveInstance.ProtocolId.GGWAVE_PROTOCOL_AUDIBLE_FAST;
                const waveform = ggwaveInstance.encode(
                    ggwaveInstance,
                    message,
                    protocol,
                    10 // Default volume, we'll adjust it later
                );
                
                // Convert to Float32Array
                const floatWaveform = new Float32Array(waveform.length);
                for (let i = 0; i < waveform.length; i++) {
                    floatWaveform[i] = waveform[i] / 32768.0; // Convert to float (-1.0 to 1.0)
                }
                
                // Apply R2-D2 effects
                const processedWaveform = applyDroidEffects(floatWaveform, settings);
                
                // Create audio buffer
                const buffer = audioContext.createBuffer(1, processedWaveform.length, audioContext.sampleRate);
                buffer.getChannelData(0).set(processedWaveform);
                
                // Create source node
                const source = audioContext.createBufferSource();
                source.buffer = buffer;
                
                // Connect to analyser for visualization
                source.connect(analyser);
                
                // Start playback
                source.start();
                
                // Animate R2-D2
                animateR2D2();
                
                // Update received message if not a test
                if (!isTest) {
                    receivedMessage.textContent = message;
                }
                
                console.log('Message sent:', message);
            } catch (err) {
                console.error('Failed to send message:', err);
                alert('Failed to send message. Please check console for details.');
            }
        }
        
        // Animate R2-D2
        function animateR2D2() {
            const r2d2 = document.getElementById('r2d2');
            
            // Add active class
            r2d2.classList.add('active');
            
            // Add random rotation
            const rotation = Math.random() * 10 - 5;
            r2d2.style.transform = `translateX(-50%) rotate(${rotation}deg)`;
            
            // Remove active class after animation
            setTimeout(() => {
                r2d2.classList.remove('active');
                r2d2.style.transform = 'translateX(-50%) rotate(0deg)';
            }, 2000);
        }
        
        // Visualize audio
        function visualize() {
            if (!analyser) return;
            
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            
            function draw() {
                // Request next frame
                requestAnimationFrame(draw);
                
                // Get frequency data
                analyser.getByteFrequencyData(dataArray);
                
                // Clear canvas
                canvasContext.fillStyle = '#333';
                canvasContext.fillRect(0, 0, audioCanvas.width, audioCanvas.height);
                
                // Draw frequency bars
                const barWidth = (audioCanvas.width / bufferLength) * 2.5;
                let x = 0;
                
                for (let i = 0; i < bufferLength; i++) {
                    const barHeight = dataArray[i] / 255 * audioCanvas.height;
                    
                    // Choose color based on frequency
                    const hue = i / bufferLength * 360;
                    canvasContext.fillStyle = `hsl(${hue}, 100%, 50%)`;
                    
                    canvasContext.fillRect(x, audioCanvas.height - barHeight, barWidth, barHeight);
                    
                    x += barWidth + 1;
                    if (x > audioCanvas.width) break;
                }
            }
            
            draw();
        }
        
        // Save as WAV
        function saveAsWav() {
            // Initialize audio if needed
            initAudio().then(() => {
                const message = messageInput.value;
                
                // Get settings from sliders
                const settings = {
                    volume: parseFloat(volumeSlider.value),
                    dutyCycle: parseFloat(dutySlider.value),
                    lfoRate: parseFloat(lfoSlider.value)
                };
                
                // Encode message using GGWave
                const protocol = ggwaveInstance.ProtocolId.GGWAVE_PROTOCOL_AUDIBLE_FAST;
                const waveform = ggwaveInstance.encode(
                    ggwaveInstance,
                    message,
                    protocol,
                    10 // Default volume, we'll adjust it later
                );
                
                // Convert to Float32Array
                const floatWaveform = new Float32Array(waveform.length);
                for (let i = 0; i < waveform.length; i++) {
                    floatWaveform[i] = waveform[i] / 32768.0; // Convert to float (-1.0 to 1.0)
                }
                
                // Apply R2-D2 effects
                const processedWaveform = applyDroidEffects(floatWaveform, settings);
                
                // Convert to 16-bit PCM
                const pcmData = new Int16Array(processedWaveform.length);
                for (let i = 0; i < processedWaveform.length; i++) {
                    pcmData[i] = Math.min(1, Math.max(-1, processedWaveform[i])) * 32767;
                }
                
                // Create WAV header
                const wavHeader = createWavHeader(pcmData.length, 1, audioContext.sampleRate, 16);
                
                // Combine header and PCM data
                const wavBlob = new Blob([wavHeader, pcmData], { type: 'audio/wav' });
                
                // Create download link
                const url = URL.createObjectURL(wavBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'r2d2_message.wav';
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                
                // Clean up
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
            });
        }
        
        // Create WAV header
        function createWavHeader(dataLength, numChannels, sampleRate, bitsPerSample) {
            const headerLength = 44;
            const byteRate = sampleRate * numChannels * bitsPerSample / 8;
            const blockAlign = numChannels * bitsPerSample / 8;
            const wavHeader = new ArrayBuffer(headerLength);
            const view = new DataView(wavHeader);
            
            // RIFF chunk descriptor
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 32 + dataLength * 2, true);
            writeString(view, 8, 'WAVE');
            
            // "fmt " sub-chunk
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); // PCM format
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitsPerSample, true);
            
            // "data" sub-chunk
            writeString(view, 36, 'data');
            view.setUint32(40, dataLength * 2, true);
            
            return wavHeader;
        }
        
        // Helper to write string to DataView
        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }
        
        // Event listeners for buttons
        testButton.addEventListener('click', () => {
            sendMessage('Test... test... test...', true);
        });
        
        sendButton.addEventListener('click', () => {
            sendMessage(messageInput.value, false);
        });
        
        saveButton.addEventListener('click', saveAsWav);
        
        // Initialize on page load
        window.addEventListener('load', () => {
            console.log('GGRoid Web Example loaded');
        });
    </script>
</body>
</html>